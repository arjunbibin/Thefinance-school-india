{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile within the FinanceVerse 3D application, managing personal information, course progress, and achievements.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user, used for communication (not for authentication as per security best practices).",
          "format": "email"
        },
        "registrationDate": {
          "type": "string",
          "description": "The date and time when the user registered.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email",
        "registrationDate"
      ]
    },
    "Course": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Course",
      "type": "object",
      "description": "Represents a financial education course available in the catalog.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Course entity."
        },
        "title": {
          "type": "string",
          "description": "The title of the financial course."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the course content and objectives."
        },
        "category": {
          "type": "string",
          "description": "The category the course belongs to (e.g., 'Investing', 'Budgeting', 'Retirement Planning')."
        },
        "durationHours": {
          "type": "number",
          "description": "The estimated duration of the course in hours."
        },
        "difficultyLevel": {
          "type": "string",
          "description": "The recommended difficulty level for the course (e.g., 'Beginner', 'Intermediate', 'Advanced')."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL to a static image representing the course thumbnail or banner.",
          "format": "uri"
        },
        "_3dModelUrl": {
          "type": "string",
          "description": "URL to the 3D model asset used to highlight key learning points for the course.",
          "format": "uri"
        },
        "learningPoints": {
          "type": "array",
          "description": "A list of key learning objectives or takeaways from the course.",
          "items": {
            "type": "string"
          }
        },
        "benefits": {
          "type": "array",
          "description": "A list of benefits users will gain from completing the course.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "title",
        "description",
        "category",
        "durationHours",
        "difficultyLevel",
        "learningPoints",
        "benefits"
      ]
    },
    "Enrollment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Enrollment",
      "type": "object",
      "description": "Tracks a user's progress and status for a specific course.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Enrollment entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile. (Relationship: UserProfile 1:N Enrollment)"
        },
        "courseId": {
          "type": "string",
          "description": "Reference to the Course. (Relationship: Course 1:N Enrollment)"
        },
        "enrollmentDate": {
          "type": "string",
          "description": "The date and time when the user enrolled in the course.",
          "format": "date-time"
        },
        "completionDate": {
          "type": "string",
          "description": "The date and time when the user completed the course, if applicable.",
          "format": "date-time"
        },
        "progressPercentage": {
          "type": "number",
          "description": "The percentage of the course that has been completed (0-100)."
        },
        "status": {
          "type": "string",
          "description": "The current status of the user's enrollment (e.g., 'Enrolled', 'InProgress', 'Completed', 'Dropped')."
        }
      },
      "required": [
        "id",
        "userId",
        "courseId",
        "enrollmentDate",
        "progressPercentage",
        "status"
      ]
    },
    "Achievement": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Achievement",
      "type": "object",
      "description": "Represents an achievement earned by a user within the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Achievement entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile who earned this achievement. (Relationship: UserProfile 1:N Achievement)"
        },
        "name": {
          "type": "string",
          "description": "The name of the achievement (e.g., 'First Course Completed', 'Budget Master')."
        },
        "description": {
          "type": "string",
          "description": "A description of how the achievement was earned."
        },
        "achievedDate": {
          "type": "string",
          "description": "The date and time when the achievement was earned.",
          "format": "date-time"
        },
        "badgeIconUrl": {
          "type": "string",
          "description": "URL to the icon or image representing the achievement badge.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "description",
        "achievedDate"
      ]
    },
    "FinancialTool": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "FinancialTool",
      "type": "object",
      "description": "Represents an interactive financial tool available in the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the FinancialTool entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the financial tool (e.g., 'Retirement Planner', 'Budget Calculator')."
        },
        "description": {
          "type": "string",
          "description": "A description of what the tool does and its purpose."
        },
        "toolType": {
          "type": "string",
          "description": "The category or type of the financial tool (e.g., 'Calculator', 'Simulator', 'Visualizer')."
        },
        "_3dModelUrl": {
          "type": "string",
          "description": "URL to the 3D model asset used for the tool's visual representation or data visualization.",
          "format": "uri"
        },
        "accessUrl": {
          "type": "string",
          "description": "The URL or internal path to access and use the financial tool.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "toolType",
        "accessUrl"
      ]
    },
    "NewsArticle": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "NewsArticle",
      "type": "object",
      "description": "Represents a financial news article aggregated from various sources.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the NewsArticle entity."
        },
        "title": {
          "type": "string",
          "description": "The title of the news article."
        },
        "summary": {
          "type": "string",
          "description": "A brief summary or excerpt of the article content."
        },
        "fullArticleUrl": {
          "type": "string",
          "description": "The URL to the original full news article on its source website.",
          "format": "uri"
        },
        "sourceName": {
          "type": "string",
          "description": "The name of the news source (e.g., 'Bloomberg', 'Wall Street Journal')."
        },
        "publishedDate": {
          "type": "string",
          "description": "The date and time when the article was published.",
          "format": "date-time"
        },
        "imageUrl": {
          "type": "string",
          "description": "URL to a relevant image for the news article thumbnail.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "title",
        "summary",
        "fullArticleUrl",
        "sourceName",
        "publishedDate"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/userProfiles/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores individual user profiles. The document ID `{userId}` MUST match the Firebase Authentication UID of the user. The `id` field within the document should also match this `{userId}` for consistency. This ensures private access, allowing users to read and write only their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, corresponding to Firebase Authentication UID."
            }
          ]
        }
      },
      {
        "path": "/courses/{courseId}",
        "definition": {
          "entityName": "Course",
          "schema": {
            "$ref": "#/backend/entities/Course"
          },
          "description": "Contains a catalog of all available financial education courses. These courses are publicly readable by all authenticated users. Administrative roles will have write access. The `id` field in the document should match the `{courseId}`.",
          "params": [
            {
              "name": "courseId",
              "description": "The unique identifier for a specific course."
            }
          ]
        }
      },
      {
        "path": "/userProfiles/{userId}/enrollments/{enrollmentId}",
        "definition": {
          "entityName": "Enrollment",
          "schema": {
            "$ref": "#/backend/entities/Enrollment"
          },
          "description": "Tracks a user's enrollment and progress in a specific course. This is a subcollection of a user's profile. Includes denormalized 'userId' field for authorization independence, which MUST match the parent `{userId}` path segment. Users can only read/write their own enrollments.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns this enrollment."
            },
            {
              "name": "enrollmentId",
              "description": "The unique identifier for a specific course enrollment."
            }
          ]
        }
      },
      {
        "path": "/userProfiles/{userId}/achievements/{achievementId}",
        "definition": {
          "entityName": "Achievement",
          "schema": {
            "$ref": "#/backend/entities/Achievement"
          },
          "description": "Records achievements earned by a user. This is a subcollection of a user's profile. Includes denormalized 'userId' field for authorization independence, which MUST match the parent `{userId}` path segment. Users can only read their own achievements.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who earned this achievement."
            },
            {
              "name": "achievementId",
              "description": "The unique identifier for a specific achievement."
            }
          ]
        }
      },
      {
        "path": "/financialTools/{toolId}",
        "definition": {
          "entityName": "FinancialTool",
          "schema": {
            "$ref": "#/backend/entities/FinancialTool"
          },
          "description": "Stores information about interactive financial tools available in the application. These tools are publicly readable by all authenticated users. Administrative roles will have write access. The `id` field in the document should match the `{toolId}`.",
          "params": [
            {
              "name": "toolId",
              "description": "The unique identifier for a specific financial tool."
            }
          ]
        }
      },
      {
        "path": "/newsArticles/{articleId}",
        "definition": {
          "entityName": "NewsArticle",
          "schema": {
            "$ref": "#/backend/entities/NewsArticle"
          },
          "description": "Aggregates financial news articles from various sources. These articles are publicly readable by all authenticated users. Administrative roles will have write access. The `id` field in the document should match the `{articleId}`.",
          "params": [
            {
              "name": "articleId",
              "description": "The unique identifier for a specific news article."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "UserRole",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "A collection used for Database-Backed Access Control (DBAC) to designate administrators. The document ID `{userId}` corresponds to the UID of an administrative user. The existence of a document in this collection grants administrative privileges across the application. Documents can be empty or contain simple metadata like `assignedAt` timestamps.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of an administrator user, corresponding to Firebase Authentication UID."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed following the core principles of Authorization Independence, Structural Segregation, and Access Modeling to ensure security, scalability, and debuggability. All static assets like the logo, 3D models, and images will be stored in Firebase Cloud Storage, with their respective URLs referenced in the Firestore documents.\n\n1.  **Authorization Independence (CRITICAL):** For user-specific subcollections (e.g., `enrollments`, `achievements`), the `userId` field is explicitly denormalized within each subcollection document. This `userId` field *must* match the `{userId}` wildcard in the parent path. This design eliminates the need for `get()` calls in security rules to check parent document ownership or attributes, making authorization atomic, efficient, and easier to debug. For instance, a rule for `userProfiles/{userId}/enrollments/{enrollmentId}` can directly check `request.auth.uid == userId && resource.data.userId == userId` without reading the `UserProfile` document.\n\n2.  **Clarity of Intent & Structural Segregation:**\n    *   **User-Owned Data:** `UserProfile`, `Enrollment`, and `Achievement` data are segregated into `/userProfiles/{userId}/...` paths. This clearly establishes path-based ownership, simplifying rules to `request.auth.uid == userId` for read/write access to a user's own data. Each subcollection (e.g., `enrollments`) contains documents homogeneous in security posture.\n    *   **Public/Global Data:** `Course`, `FinancialTool`, and `NewsArticle` entities are placed in top-level collections (`/courses`, `/financialTools`, `/newsArticles`). These collections are intended for public read access by all authenticated users and administrative write access. This structural segregation ensures that documents with different access patterns are not mixed, simplifying rules and client-side querying.\n    *   **DBAC (Database-backed Access Control):** A dedicated `/roles_admin/{userId}` collection is used for global administrator roles. The mere existence of a document with a user's UID in this collection grants administrative privileges, allowing rules to check `exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))` for elevated permissions. This adheres to the \"Existence over Content\" principle.\n\n3.  **QAPs (Query as Authorization Predicates):**\n    *   **Public Collections (`/courses`, `/financialTools`, `/newsArticles`):** These collections are globally readable, allowing any user to list all documents. Security rules simply allow `read` access, inherently supporting QAPs without requiring client-side filtering or complex rule logic.\n    *   **User-Owned Subcollections (`/userProfiles/{userId}/enrollments`, `/userProfiles/{userId}/achievements`):** When a user queries their own subcollection (e.g., `db.collection('userProfiles').doc(request.auth.uid).collection('enrollments')`), the query path itself (`/userProfiles/{uid}/enrollments`) implicitly filters for the requesting user's data. The security rules then only need to verify that `request.auth.uid` matches the `userId` in the path, ensuring that users only retrieve their own authorized data directly from the database without filtering by rules. The `userId` field within each document further reinforces this, providing an additional invariant check (`resource.data.userId == userId`) to prevent misconfigurations or malicious writes."
  }
}